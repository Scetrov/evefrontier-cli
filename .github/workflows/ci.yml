name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build-and-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Install cargo-audit
              run: |
                  set -e
                  if ! command -v cargo-audit >/dev/null 2>&1; then
                    cargo install cargo-audit || true
                  fi

            - name: Build Rust workspace
              run: cargo build --workspace --verbose

            - name: Run cargo tests
              run: cargo test --workspace --verbose

            - name: Run cargo-audit (reports vulnerabilities)
              run: |
                  set -e
                  if command -v cargo-audit >/dev/null 2>&1; then
                    cargo audit || true
                  else
                    echo "cargo-audit not installed; skipped";
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "pnpm"

            - name: Enable Corepack and install pnpm
              run: |
                  corepack enable
                  corepack prepare pnpm@latest --activate
                  pnpm --version
                  pnpm install --frozen-lockfile

            - name: Nx build sanity check
              run: npx nx run-many --target=build --all --verbose || true
